generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sport {
  pool
  darts
}

enum FixtureStatus {
  scheduled
  in_progress
  completed
}

enum FixtureState {
  SCHEDULED
  IN_PROGRESS
  SUBMITTED
  AWAITING_OPPONENT
  DISPUTED
  LOCKED
}

enum MatchEventType {
  FRAME_RECORDED
  MATCH_EDITED
  MATCH_COMPLETED
  ADMIN_LOCK_OVERRIDE
  RESULT_SUBMITTED
  OPPONENT_REVIEW_REQUESTED
  RESULT_APPROVED
  RESULT_REJECTED
  TOKEN_ISSUED
  TOKEN_TRANSFERRED
  TOKEN_ACCEPTED
  DISPUTE_OPENED
  DISPUTE_RESOLVED
}

enum DisputeStatus {
  open
  under_review
  resolved
  rejected
}

enum Role {
  ORG_ADMIN
  COMMISSIONER
  CAPTAIN
  PLAYER
}

enum OutboxStatus {
  pending
  sending
  sent
  failed
}

enum NotificationChannel {
  sms
  whatsapp
  email
}

enum SponsorScopeType {
  ORG
  LEAGUE
  DIVISION
}

model Organisation {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  leagues     League[]
  memberships OrgMembership[]
  players     Player[]

  rulesets           Ruleset[]
  notificationOutbox NotificationOutbox[]
  rosterTransfers    RosterTransferAudit[]
  sponsorSlots       SponsorSlot[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  memberships OrgMembership[]
  matchEvents MatchEvent[]
  rosterTransfers RosterTransferAudit[]
}

model OrgMembership {
  id             String   @id @default(uuid())
  organisationId String
  userId         String
  role           Role
  createdAt      DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organisationId, userId])
}

model Ruleset {
  id             String   @id @default(uuid())
  organisationId String
  name           String
  sport          Sport
  config         Json
  createdAt      DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  leagues      League[]
}

model League {
  id             String   @id @default(uuid())
  organisationId String
  name           String
  sport          Sport
  rulesetId      String
  createdAt      DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  ruleset      Ruleset      @relation(fields: [rulesetId], references: [id])
  seasons      Season[]
}

model Season {
  id        String   @id @default(uuid())
  leagueId  String
  name      String
  startDate DateTime
  endDate   DateTime
  rosterLockAfterAppearances     Int      @default(1)
  allowMidSeasonTransfers        Boolean  @default(false)
  requireAdminApprovalForTransfer Boolean @default(true)
  maxTeamChangesAfterLock        Int      @default(0)

  league      League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  divisions   Division[]
  teamPlayers TeamPlayer[]
  rosterTransfers RosterTransferAudit[]
}

model Division {
  id       String @id @default(uuid())
  seasonId String
  name     String

  season             Season              @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  teams              Team[]
  fixtures           Fixture[]
  standingsSnapshots StandingsSnapshot[]
}

model Team {
  id         String @id @default(uuid())
  divisionId String
  name       String

  division     Division     @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  roster       TeamPlayer[]
  homeFixtures Fixture[]    @relation("HomeTeam")
  awayFixtures Fixture[]    @relation("AwayTeam")
  tokens       MatchControlToken[]
  transfersOut RosterTransferAudit[] @relation("RosterTransferFromTeam")
  transfersIn  RosterTransferAudit[] @relation("RosterTransferToTeam")
}

model Player {
  id             String   @id @default(uuid())
  organisationId String
  displayName    String
  contactEmail   String?
  contactPhone   String?
  createdAt      DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  teams        TeamPlayer[]
  heldTokens   MatchControlToken[]
  rosterTransfers RosterTransferAudit[]
}

model TeamPlayer {
  id       String   @id @default(uuid())
  teamId   String
  seasonId String
  playerId String
  role     Role // CAPTAIN or PLAYER (reuse enum; keep simple)
  joinedAt DateTime @default(now())

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerId])
  @@unique([playerId, seasonId])
}

model Fixture {
  id          String        @id @default(uuid())
  divisionId  String
  homeTeamId  String
  awayTeamId  String
  scheduledAt DateTime?
  status      FixtureStatus @default(scheduled)
  state       FixtureState  @default(SCHEDULED)

  division Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  homeTeam Team     @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam Team     @relation("AwayTeam", fields: [awayTeamId], references: [id])

  tokens   MatchControlToken[]
  events   MatchEvent[]
  disputes Dispute[]
}

model MatchControlToken {
  id                    String    @id @default(uuid())
  fixtureId             String
  teamId                String
  currentHolderPlayerId String
  issuedAt              DateTime  @default(now())
  acceptedAt            DateTime?
  revokedAt             DateTime?

  fixture       Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  team          Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  currentHolder Player  @relation(fields: [currentHolderPlayerId], references: [id], onDelete: Restrict)
}

model MatchEvent {
  id          String   @id @default(uuid())
  fixtureId   String
  revision    Int
  eventType   MatchEventType
  actorUserId String
  payload     Json
  createdAt   DateTime @default(now())

  fixture   Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
  actorUser User    @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  @@unique([fixtureId, revision])
  @@index([fixtureId, createdAt])
}

model StandingsSnapshot {
  id         String   @id @default(uuid())
  divisionId String
  data       Json
  createdAt  DateTime @default(now())

  division Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@index([divisionId, createdAt])
}

model Dispute {
  id        String   @id @default(uuid())
  fixtureId String
  status    DisputeStatus
  reason    String?
  outcome   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fixture Fixture @relation(fields: [fixtureId], references: [id], onDelete: Cascade)
}

model NotificationOutbox {
  id                String              @id @default(uuid())
  organisationId    String
  channel           NotificationChannel
  to                String
  templateKey       String
  templateVars      Json
  scheduledFor      DateTime
  status            OutboxStatus        @default(pending)
  attempts          Int                 @default(0)
  lastError         String?
  providerMessageId String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId, status, scheduledFor])
}

model RosterTransferAudit {
  id             String   @id @default(uuid())
  organisationId String
  seasonId       String
  playerId       String
  fromTeamId     String
  toTeamId       String
  effectiveFrom  DateTime @default(now())
  appliedAt      DateTime?
  actorUserId    String
  reason         String
  wasAdminOverride Boolean @default(false)
  createdAt      DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  season       Season       @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  player       Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  fromTeam     Team         @relation("RosterTransferFromTeam", fields: [fromTeamId], references: [id], onDelete: Cascade)
  toTeam       Team         @relation("RosterTransferToTeam", fields: [toTeamId], references: [id], onDelete: Cascade)
  actorUser    User         @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  @@index([organisationId, seasonId, playerId, createdAt])
  @@index([organisationId, seasonId, effectiveFrom, appliedAt])
}

model SponsorSlot {
  id             String           @id @default(uuid())
  organisationId String
  scopeType      SponsorScopeType
  scopeId        String?
  title          String?
  imageUrl       String
  linkUrl        String?
  startAt        DateTime?
  endAt          DateTime?
  sortOrder      Int              @default(0)
  createdAt      DateTime         @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([organisationId, scopeType, scopeId, sortOrder, createdAt])
}
